name: "Release: 1. Preparation ðŸš€"
on:
  workflow_dispatch:
    inputs:
      type:
        description: 'What type of release is this?'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - rc
      codename:
        description: 'The codename for this release, empty for same as last'
        required: false
      version:
        description: 'The version date YYYY-MM-DD, empty for today'
        required: false

jobs:
  create:
    name: Prepare Pull Request
    runs-on: ubuntu-latest
    steps:
      - name: Fail if branch is not master
        if: github.ref != 'refs/heads/master'
        run: |
          echo "::error::This workflow should only be triggered on master"
          exit 1

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set git identity
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Prepare Environment
        run: |
          php .github/release.php new \
              --date "${{ inputs.version }}" \
              --name "${{ inputs.codename }}" \
              --type "${{ inputs.type }}" \
              >> $GITHUB_ENV

      - name: Create merge commit with version info
        run: |
          git merge -s ours origin/stable
          echo '${{ env.next_raw }}' > VERSION
          git add VERSION
          git commit --amend -m 'Release preparations for ${{ env.next_raw }}'
          git log -1
          git log origin/stable..master --oneline
          git checkout -B auto-${{ env.next_version }}
          git push --set-upstream origin auto-${{ env.next_version }}

      - name: Create pull request
        uses: repo-sync/pull-request@v2
        with:
          source_branch: auto-${{ env.next_version }}
          destination_branch: stable
          pr_title: Release Preparations for ${{ env.next_raw }}
          pr_body: |
            With accepting this PR, a the stable branch will be updated.

            * ${{ env.current_raw }} -> ${{ env.next_raw }}
            * Update Version ${{ env.current_update }} -> ${{ env.next_update }}

            Before merging this PR, make sure that:

            - [ ] Ensure all tests pass
            - [ ] If this is a release, make sure you copied merged stable into old-stable
            - [ ] Check that a meaningful [changelog](https://www.dokuwiki.org/changes) exists

            After merging, the release workflow will be triggered automatically. It will create the
            appropriate tag, build a tgz and copy it to our download server.

            After this is done, you need to do the following things manually:

            - [ ] Update the [version symlinks](https://download.dokuwiki.org/admin/)
            - [ ] Update the update message system
            - [ ] Announce the release on the mailinglist, forum, IRC, social media, etc.

