name: "ðŸš€ Prepare Release"
on:
    workflow_dispatch:
        inputs:
            type:
                description: 'What type of release is this?'
                required: true
                default: 'stable'
                type: choice
                options:
                    - stable
                    - rc
            codename:
                description: 'The codename for this release, empty for same as last'
                required: false
            version:
                description: 'The version date YYYY-MM-DD, empty for today'
                required: false

jobs:
    create:
        name: Prepare Pull Request
        runs-on: ubuntu-latest
        steps:
            -   name: Fail if branch is not master
                if: github.ref != 'refs/heads/master'
                run: |
                    echo "::error::This workflow should only be triggered on master"
                    exit 1

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: 8.1

            -   name: Checkout
                uses: actions/checkout@v3
                with:
                    fetch-depth: 0

            -   name: Set git identity
                run: |
                    git config --global user.name "${{ github.actor }}"
                    git config --global user.email "${{ github.actor }}@users.noreply.github.com"

            -   name: Prepare Environment
                run: |
                    php .github/release.php \
                        --date "${{ inputs.version }}" \
                        --name "${{ inputs.codename }}" \
                        --type "${{ inputs.type }}" \
                        >> $GITHUB_ENV

            -   name: Create merge commit with version info
                run: |
                    git merge -s ours origin/stable
                    echo ${{ env.next_raw }} > VERSION
                    git add VERSION
                    git commit --amend -m "Release preparations for ${{ env.next_raw }}"
                    git log -1
                    git log origin/stable..master --oneline
                    git checkout -B auto-${{ env.next_version }}
                    git push --set-upstream origin auto-${{ env.next_version }}

            -   name: Create pull request
                uses: repo-sync/pull-request@v2
                with:
                    source_branch: auto-${{ env.next_version }}
                    destination_branch: stable
                    pr_title: Release Preparations for ${{ env.next_raw }}
                    pr_body: |
                        This merges current master into stable.

                        - There are things to do first
                        - I don't know what yet

